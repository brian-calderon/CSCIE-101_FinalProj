---
title: "Final_Project"
author: "Brian Calderon"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


---
title: "Group Project"
output: pdf_document
date: "2025-04-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
#install.packages("fastDummies")
library(ISLR2)
library(tidyverse)
library(caret)
library(MASS)
library(fastDummies)
library(stringr)
odata<- read.csv("./template/Titanic_Survival_Data.csv")
cat("Size of entire data set:", nrow(odata), "\n")

#Remove Unneeded Columns'
data <- odata[, !(names(odata) %in% c("name", "ticket", "boat","body","home.dest"))]

#Replace NAs in age column with Median value 
median_age <- median(data$age, na.rm = TRUE)
data <- data %>%
  mutate(age = ifelse(is.na(age), median_age, age))

#Extract deck letter from cabin
data$deck <- substr(data$cabin, 1,1)
data$cabin <- NULL

# Convert into factors
data$deck <- factor(data$deck, levels = c("A", "B", "C", "D", "E", "F", "G", "T"))
data$sex <- factor(data$sex, levels = c("female", "male"))
data$embarked <- factor(data$embarked, levels = c("C", "Q", "S"))

# Remove rows with NA in any of the categorical columns in order for fast dummies to work correctly
data <- data %>% filter(!is.na(sex), !is.na(embarked), !is.na(deck))

#Create dummy variables
data <- data %>%
  fastDummies :: dummy_cols(select_columns = c("sex", "embarked","deck"),
                            remove_selected_columns = TRUE,
                            remove_first_dummy = TRUE)

#Remove NAs
data <-na.omit(data)
#head(data)
set.seed(15)

#split data into train and test
datasplit <- data %>%
  group_by(survived) %>%
  group_split() %>%
  lapply(function(df) sample(seq_len(nrow(df)), size = 0.7 * nrow(df))) %>%
  unlist()

data_train<-data[datasplit,]
data_test<-data[-datasplit,]

#check the data
cat("Training data set size:", nrow(data_train), "\n")
cat("Testing data set size:", nrow(data_test), "\n")
cat("Size of entire data set:", nrow(data), "\n")
head(data)






```
``` {r poisson}
  library(MASS)

  cutoff.prg<-function(pred,act){
  # pred<-predicted_probabilities
  # act<-true_labels
  p<-seq(0,1,0.01)
  n<-length(p)
  out<-matrix(0,nrow=n,ncol=12)
  for(i in 1:n){
  predictions <- ifelse(pred >p[i], 1, 0)
  confusion_matrix <- confusionMatrix(as.factor(predictions),as.factor(act),mode="prec_recall", positive = "1")
  out[i,]<-cbind(p=p[i],t(confusion_matrix[[4]]))
  }
  dimnames(out)[[2]]<-c("p","Sensitivity","Specificity","Pos Pred Value","Neg Pred Value","Precision","Recall", "F1","Prevalence","Detection Rate","Detection Prevalence", "Balanced Accuracy")
  out
  }

  poissonReg <- glm(survived~.,family=poisson, data_train)
  sumary(poissonReg)
  
  # compare the fitted model to the null model
  1-pchisq(24.41141, 12)
  
  anova(poissonReg,test="Chi")
  drop1(poissonReg,test="Chi")
  
  # Testing against test data
  
  predicted_probs <- predict(poissonReg, newdata = data_test, type = "response")
  
  predictions <- ifelse(predicted_probs > 0.49, 1, 0)
  confusion_matrix <- confusionMatrix(as.factor(predictions), as.factor(data_test$survived), mode="prec_recall", positive = "1")
  confusion_matrix 
  
  test<-cutoff.prg(predicted_probs,data_test$survived)
  plot(test[,1],test[,8],xlab="cut off",ylab="F1")
  test[which.max(test[,8]),]

```
\par Ho: Variables are not important
\par Ha: Variable are important
\par Since we have a p-value of 0.017, we reject the null hypothesis. Variables are important.

\par According to the regression the male variable decreases the log-odds of survival by 0.78211, which translates to a 54% lower odds of survival compared to being female.
\par Assuming a alpha of 0.05, when adding sequentially to the model, only the sex_male variable is significant (a p-value of 1.368e-05). Additionally, when performing the drop one test, we see that only the sex_male variable is significantly affecting the model (a p-value of 2.575e-05). Therefore, the sex vairable is the only statistically significant variable within the model.

\par For the Poisson Regression, only sex_male is significant. 

\par Our Poisson Regression has a balanced accuracy of 80.92% with optimal cutoï¬€(.49) based on max F1 score (.8302).