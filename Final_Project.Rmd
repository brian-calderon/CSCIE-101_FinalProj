---
title: "Final_Project"
author: "Brian Calderon"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
#install.packages("fastDummies")
library(ISLR2)
library(tidyverse)
library(caret)
library(MASS)
library(fastDummies)
library(stringr)
odata<- read.csv("Titanic_Survival_Data.csv")
cat("Size of entire data set:", nrow(odata), "\n")

odata = odata[-1,]

#Remove Unneeded Columns'
data <- odata[, !(names(odata) %in% c("name", "ticket", "boat","body","home.dest"))]

#Replace NAs in age column with Median value 
median_age <- median(data$age, na.rm = TRUE)
data <- data %>%
  mutate(age = ifelse(is.na(age), median_age, age))

#Extract deck letter from cabin
data$deck <- substr(data$cabin, 1,1)
data$cabin <- NULL


# Convert into factors
data$deck <- factor(data$deck, levels = c("A", "B", "C", "D", "E", "F", "G", "T"))
data$sex <- factor(data$sex, levels = c("female", "male"))
data$embarked <- factor(data$embarked, levels = c("C", "Q", "S"))

mode_fctr <- function(x) levels(x)[which.max(tabulate(match(x, levels(x))))]

mode_sex <- mode_fctr(data$sex)
mode_deck <- mode_fctr(data$deck)
mode_embark <- mode_fctr(data$embarked)

data$deck[is.na(data$deck)] <- mode_deck
data$sex[is.na(data$sex)] <- mode_sex
data$embarked[is.na(data$embarked)] <- mode_embark


#Create dummy variables
data <- data %>%
  fastDummies :: dummy_cols(select_columns = c("sex", "embarked","deck"),
                            remove_selected_columns = TRUE,
                            remove_first_dummy = TRUE)

#Remove NAs
data <-na.omit(data)
#head(data)
set.seed(15)

#split data into train and test
datasplit <- sample(1:length(data$survived),0.7*length(data$survived))

data_train<-data[datasplit,]
data_test<-data[-datasplit,]

#check the data
cat("Training data set size:", nrow(data_train), "\n")
cat("Testing data set size:", nrow(data_test), "\n")
cat("Size of entire data set:", nrow(data), "\n")
head(data)

```
```{r logistic regression model}

lmod <- glm(survived ~ ., family = binomial, data = data_train)
print(summary(lmod))
print(1-pchisq(1218.39-832.75, 14))

```

```{r step applied}

lmod_step = step(lmod,direction = "both", trace = 0)
summary(lmod_step)

plot(lmod_step,4)

```

```{r confusion matrix}
predicted_probabilities_2 <- predict(lmod_step, data_train, type="response")

prob<-predicted_probabilities_2
library(pROC)
par(mfrow=c(1,1))
survived_roc <- roc(data_train$survived,prob)
plot.roc(survived_roc,print.auc=TRUE, col = "blue", lwd = 2, legacy.axes = TRUE)
```

```{r pick the cutoff}
cutoff.prg<-function(pred,act){
# pred<-predicted_probabilities
# act<-true_labels
p<-seq(0,1,0.01)
n<-length(p)
out<-matrix(0,nrow=n,ncol=12)
for(i in 1:n){
predictions <- ifelse(pred >p[i], 1, 0)
confusion_matrix <- confusionMatrix(as.factor(predictions),as.factor(act),mode="prec_recall", positive = "1")
out[i,]<-cbind(p=p[i],t(confusion_matrix[[4]]))
}
dimnames(out)[[2]]<-c("p","Sensitivity","Specificity","Pos Pred Value","Neg Pred Value","Precision","Recall", "F1","Prevalence","Detection Rate","Detection Prevalence", "Balanced Accuracy")
out
}

test<-cutoff.prg(predicted_probabilities_2,observations)
plot(test[,1],test[,8],xlab="cut off",ylab="F1")
test[which.max(test[,8]),]
```

```{r}
plot(test[,1],                           
     test[,8],
     type = "l",
     col = 2,
     xlab = "cut off",
     ylab = "rates",
     ylim = c(0,1))
 
# Add line graphs of other two data set
lines(test[,1],                             
      test[,2],
      type = "l",
      col = 3)
lines(test[,1],                             
      test[,3],
      type = "l",
      col = 4)
# Add legend in top right corner
legend("topright",                           
       c("F1", "Sensitivity", "Specificity"),
       lty = 1,
       col = 2:4)


diff_cutoff = test[which.min(I(test[,2]-test[,3])^2),]
print(diff_cutoff)
```



```{r performance on train data}
predictions_2 <- ifelse(predicted_probabilities_2 > 0.36, 1, 0)
observations = data_train$survived
confusion_matrix_2 <- confusionMatrix(as.factor(predictions_2),as.factor(observations),mode="prec_recall", positive = "1")
confusion_matrix_2 

```


```{r performance of test data}

predicted_probabilities_3 <- predict(lmod_step, data_test, type="response")

predictions_3 <- ifelse(predicted_probabilities_3 > 0.36, 1, 0)
observations_3 = data_test$survived
confusion_matrix_3 <- confusionMatrix(as.factor(predictions_3),as.factor(observations_3),mode="prec_recall", positive = "1")
confusion_matrix_3 

```